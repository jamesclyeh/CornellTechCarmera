<!DOCTYPE html>

<html>

<head>
    <title>Sprint 2 Carmera</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
</head>

<body>
    <header>
        <nav>
            <div class="logo"></div>
            <div id="carmera">Carmera <span id="dataExplorer">Data Explorer <span id="beta">Beta</span></span>
            </div>
        </nav>
    </header>

    <div class="content-wrapper">
        <div id="mapbox"></div>
        <div id="informationWrapper">
            <div id="imageWrap">
                {% for image in images %}
                <img src="{{ url_for('pictures', filename='%s.jpg'%(image.image_id))}}" id="{{image.image_id}}" style="width:210px;height:210px;" /> {% endfor %}
            </div>
            <div id="infoWrap">
                <div class="sub-content-wrapper">
                    <div id="area-content">
                        <div id="area">
                            <h1>Area</h1>
                            <h3>Select...</h3>
                            <form>
                                <input type="radio" name="area" value="region" checked> A region on a map<br>
                                <input type="radio" name="area" value="radius"> An address: <input type="text" name="addressname"> and radius: <input type="text" name="radiusname"><br>
                                <input type="radio" name="area" value="city"> A city<br>
                                <input type="radio" name="area" value="neighborhood"> A neighborhood
                            </form>
                        </div>
                        <div id="content">
                            <h1>Content</h1>
                            <form>
                                <input type="checkbox" name="image" value="jpg" id="img"><label for="img"> Image</label><br>
                                <input type="checkbox" name="video" value="mp4" id="vid"><label for="vid"> Video</label>
                            </form>
                        </div>

                    </div>
                    <div id="time">
                        <h1>Time</h1>
                        <div id="date">
                            <h3>Date</h3>
                            <form>
                                <input type="radio" name="area" value="single" checked> Single day: <input type="text" name="singleday"><br>
                                <input type="radio" name="area" value="90"> Last 90 days<br>
                                <input type="radio" name="area" value="30"> Last 30 days<br>
                                <input type="radio" name="area" value="7"> Last 7 days<br>
                                <input type="radio" name="area" value="range"> <input type="text" name="dayone"> to <input type="text" name="daytwo">
                            </form>
                        </div>
                        <div id="time-of-day">
                            <h3>Time of Day</h3>
                            <form>
                                <input type="checkbox" name="image" value="jpg" id="img"><label for="img"> Image</label><br>
                                <input type="checkbox" name="video" value="mp4" id="vid"><label for="vid"> Video</label>
                            </form>
                        </div>

                    </div>
                </div>
                <div class="tag-wrapper">
                    <h1>Tags</h1>
                    <input type="text" name="taginfo"><br>
                    <div id="sug">
                        <h3>Suggested Tags</h3>
                        <ul id="suggested_tags_list" class="tags">
                            {% for tag in all_tags %}
                            <li class="suggested_tag">{{'%s +' % tag}}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div id="sel">
                        <h3>Selected Tags</h3>
                        <ul id="selected_tags_list" class="tags">
                            {% for tag in all_tags %}
                            <li class="selected_tag">{{'%s -' % tag}}</li>
                            {% endfor %}
                        </ul>
                    </div>

                </div>
                <button class="save">Save Changes</button><button class="cancel">Cancel</button>

            </div>
            <div id="results" style="display: none;">
                <p>5,000+ Results</p><button class="filter">Filter Options</button></div>

        </div>
    </div>


    <script type="text/javascript" src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        L.mapbox.accessToken = 'pk.eyJ1IjoiamFtZXNjbHllaCIsImEiOiJjaXVqN2NpdzkwMGF6MnVucXlvdzJpODdiIn0.Ag-NcIZ9BEc_79IczpLVEg';
        //var map = new L.Map({
        //  container: 'mapbox', // container id
        //  style: 'mapbox://styles/mapbox/streets-v9', //stylesheet location
        //  center: [-74.0016876, 40.7409227], // starting position
        //  zoom: 15 // starting zoom
        //});
        var images = {
            {
                data | tojson
            }
        };
        var map = L.mapbox.map('mapbox', 'mapbox.streets').setView([40.7409227, -74.0016876], 20);
        var markerLayer;

        $(document).ready(function() {
            $('#imageWrap').hide();
            updateMarker(images);
            $("#selected_tags_list li").hide();
            $("li.suggested_tag").click(function() {
                var tag_name = $(this).html().slice(0, -2);
                console.log(tag_name)
                $("#selected_tags_list li").each(function() {
                    var liText = $(this).text();
                    if (liText.indexOf(tag_name) == 0)
                        $(this).show();
                });
                $(this).hide();
            });

            $("li.selected_tag").click(function() {
                var tag_name = $(this).html().slice(0, -2);
                $("#suggested_tags_list li").each(function() {
                    var liText = $(this).text().slice(0, -2);
                    console.log(liText);
                    console.log(liText.indexOf(tag_name))
                    if (liText.indexOf(tag_name) == 0)
                        $(this).show();
                });
                $(this).hide();
            });

            $(".save").click(function() {
                info.style.display = "none";
                results.style.display = "block";
                filterByTags();
            });
        });

        function filterByTags() {
            var selected = []
            $("#selected_tags_list li").each(
                function() {
                    if ($(this).css('display') != 'none') {
                        selected.push($(this).text().slice(0, -2));
                    }
                });
            $.ajax({
                type: "POST",
                url: 'http://localhost:5000/filterByTag?tags=' + selected.join(),
                success: function(result) {
                    images = JSON.parse(result);
                    updateMarker(images);
                    updateImages(images);
                    $('#imageWrap').show();
                },
                async: true
            });
        }

        function updateMarker(images) {
            if (markerLayer != null) {
                markerLayer.clearLayers();
            }
            var geocodes = []
            for (i = 0; i < images.length; i++) {
                // console.log(images[i])
                geocodes.push({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [images[i]['lon'], images[i]['lat']]
                    },
                    properties: {
                        'marker-color': '#63b6e5'
                    }
                })
            }
            markerLayer = L.mapbox.featureLayer().setGeoJSON(geocodes).addTo(map);
        }

        function updateImages(images) {
            $("#imageWrap").children('img').each(function() {
                $(this).hide();
            });
            for (i = 0; i < images.length; i++) {
                console.log('#' + images[i].image_id)
                $("img#" + images[i].id).show();
            }
        }
    </script>
</body>

</html>